SELECT
    SP.FECHA                             AS Fecha,
    SP.CONCEPTO                          AS Concepto,
    SP.NUMERO                            AS Numero,
    SP.PERSONA                           AS "Razon Social",
    SP.RUC                               AS Ruc,
    --TV.CANAL                             AS Canal,
    SUM(SP.EXENTA)                       AS Exenta,
    SUM(SP.GRAVADA)                      AS "Gravada10%",
    SUM(SP.G5)                           AS "Gravada5%",
    SUM(SP.IMPUESTO)                     AS "Impuesto10%",
    (SUM(SP.EXENTA) + SUM(SP.GRAVADA) + SUM(SP.G5) + SUM(SP.IMPUESTO)) AS Total
FROM SP_LibroVenta_new1(
        0,
        :FECHA_DESDE,   
        :FECHA_HASTA,   
        :IDSUCURSAL     
) SP
INNER JOIN (
    SELECT
        t.fecha,
        t.NRO_FACTURA,
        CASE
            WHEN t.CANAL IS NULL THEN 'FACT. CRED MAYORISTA'
            ELSE t.CANAL
        END AS CANAL
    FROM (
        SELECT
            CAST(M.FECHA AS DATE) AS FECHA,
            CAST(
                LPAD(COALESCE(S.COD_TIMBRADO, '0'), 3, '0') || '-' ||
                LPAD(COALESCE(M.PEXPEDICION,   '0'), 3, '0') || '-' ||
                LPAD(COALESCE(M.NROMOVIMIENTO, '0'), 7, '0')
                AS VARCHAR(15)
            ) AS NRO_FACTURA,
            CASE
                WHEN GC.MODULO = 3 THEN 'SALON'
                ELSE GGM.NOMBRE
            END AS CANAL
        FROM MOVIMIENTOS M
        INNER JOIN DETALLEMOVIMIENTO DM ON M.IDMOVIMIENTO = DM.IDMOVIMIENTO
        INNER JOIN ARTICULO A            ON A.IDARTICULO    = DM.IDARTICULO
        INNER JOIN FAMILIAARTICULO F     ON F.IDFAMILIA     = A.IDFAMILIA
        INNER JOIN LINEA L               ON L.IDLINEA       = A.IDLINEA
        INNER JOIN MARCA MC              ON MC.IDMARCA      = A.IDMARCA
        INNER JOIN SUCURSAL S            ON S.IDSUCURSAL    = M.IDSUCURSAL
        INNER JOIN DEPOSITO DP           ON DP.IDDEPOSITO   = DM.IDDEPOSITO
        LEFT  JOIN GG_ORIGEN GG_OR       ON GG_OR.IDORIGEN  = M.IDORIGEN
        INNER JOIN PERSONA P             ON P.IDPERSONA     = M.IDPERSONA
        LEFT  JOIN GG_COMANDA GC         ON GC.IDMOVIMIENTO = M.IDMOVIMIENTO
        LEFT  JOIN GG_MODULO  GGM        ON GGM.IDMODULO    = GC.MODULO
        LEFT  JOIN GG_ORIGEN  GGO        ON GC.IDORIGEN     = GGO.IDORIGEN
        WHERE
            M.FECHA BETWEEN :FECHA_DESDE AND :FECHA_HASTA
           -- AND M.ESTADO <> 'A'
            AND M.IDTIPOMOVIMIENTO IN (30, 3, 62, 104, 61, 36, 37)
    ) AS T
    GROUP BY
        t.fecha,
        t.NRO_FACTURA,
        t.canal
) TV
    ON TV.NRO_FACTURA = SP.NUMERO
GROUP BY
    SP.FECHA,
    SP.CONCEPTO,
    SP.NUMERO,
    SP.PERSONA,
    SP.RUC
    --TV.CANAL
ORDER BY
    SP.NUMERO;
