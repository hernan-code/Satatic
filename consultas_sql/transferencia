SELECT 
    TRIM(CASE  
        WHEN CHAR_LENGTH(d.idarticulo) = 6 AND SUBSTRING(d.idarticulo FROM 1 FOR 1) = '1' THEN 'BCN'
        WHEN CHAR_LENGTH(d.idarticulo) = 5 AND SUBSTRING(d.idarticulo FROM 1 FOR 1) = '1' THEN 'PARLA'
        WHEN CHAR_LENGTH(d.idarticulo) = 5 AND SUBSTRING(d.idarticulo FROM 1 FOR 1) = '2' THEN 'GAMA'
    END) AS SERVER,

    CAST(m.FECHA AS DATE) AS FECHA,
    m.FECHA_CARGA,
    t1.DESCRIPCION AS TIPO_MOVIMIENTO,

    dd1.DESCRIPCION AS ENVIA,
    dd.DESCRIPCION AS RECIBE,

    d.IDMOVIMIENTO,
    f.DESCRIPCION AS FAMILIA,
    l.DESCRIPCION AS LINEA,
    a.BARCODE,
    d.IDARTICULO,
    a.DESCRIPCION,
    m2.DESCRIPCION AS MEDIDA,
    d.CANTIDAD

FROM MOVIMIENTOS m
INNER JOIN DETALLEMOVIMIENTO d ON d.IDMOVIMIENTO = m.IDMOVIMIENTO
INNER JOIN ARTICULO a ON a.IDARTICULO = d.IDARTICULO

-- depósitos
INNER JOIN DEPOSITO dd1 ON dd1.IDDEPOSITO = d.IDDEPOSITO      -- envía
INNER JOIN DEPOSITO dd ON dd.IDDEPOSITO = d.IDDEPOSITO1       -- recibe

-- estructura del artículo
INNER JOIN LINEA l ON l.IDLINEA = a.IDLINEA
INNER JOIN FAMILIAARTICULO f ON f.IDFAMILIA = l.IDFAMILIA
INNER JOIN MEDIDA m2 ON m2.IDMEDIDA = a.IDMEDIDA
INNER JOIN TIPOMOVIMIENTO t1 ON t1.IDTIPOMOVIMIENTO = m.IDTIPOMOVIMIENTO

WHERE 
    m.FECHA BETWEEN CAST('2025-08-03' AS DATE) AND CAST('2025-08-09' AS DATE)
    AND m.IDTIPOMOVIMIENTO IN (42, 14)
    AND m.ESTADO NOT IN ('A')

GROUP BY
    m.FECHA,
    m.FECHA_CARGA,
    dd1.DESCRIPCION,
    dd.DESCRIPCION,
    d.IDMOVIMIENTO,
    f.DESCRIPCION,
    l.DESCRIPCION,
    a.BARCODE,
    d.IDARTICULO,
    a.DESCRIPCION,
    m2.DESCRIPCION,
    d.CANTIDAD,
    t1.DESCRIPCION;
