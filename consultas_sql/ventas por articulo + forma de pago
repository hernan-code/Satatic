/* VENTAS POR ARTICULO + FORMA DE PAGO (UNA FILA POR ARTICULO Y TIPO DE PAGO) */

SELECT
    SERVER,
    BARCODE,
    IDMOVIMIENTO,
    NRO_FACTURA,
    ANHO,
    MES,
    NMES,
    DIA,
    DIA_SEMANA,
    FECHA,
    HORA,
    HORA2,
    IDSUCURSAL,
    SUCURSAL,
    IDDEPOSITO,
    DEPOSITO,
    IDMARCA,
    MARCA,
    IDORIGEN,
    ORIGEN,
    IDPLANVENTA,
    PLANVENTA,
    IDPERSONA,
    RUC,
    DOCUMENTO_IDENTIDAD,
    PERSONA,
    IDFAMILIA,
    FAMILIA,
    IDLINEA,
    LINEA,
    IDARTICULO,
    ARTICULO,
    ETIQUETA_DE_PRECIO,
    CANTIDAD,
    GRAVADA,
    EXENTA,
    IVA,
    PRECIO_UNITARIO_SIN_DESCUENTO,
    PORC_DESCUENTO,
    precio_unitario_con_descuento,
    TOTAL_GRAVADAS,
    TOTAL_EXENTA,
    TOTAL_GRAVADAS_MAS_EXENTA,
    TOTAL_IVA,
    TOTAL_IMPORTE,

    /* CAMPOS DE FORMA DE PAGO */
    IDTIPOPAGO,
    FORMA_PAGO,
    MONTO_FORMA_PAGO

FROM
(
    SELECT
        /* Agrupación por sucursal */
        TRIM(CASE  
            WHEN CHAR_LENGTH(A.IDARTICULO) = 6 AND SUBSTRING(A.IDARTICULO FROM 1 FOR 1) = '1' THEN 'BCN'
            WHEN CHAR_LENGTH(A.IDARTICULO) = 5 AND SUBSTRING(A.IDARTICULO FROM 1 FOR 1) = '1' THEN 'PARLA'
            WHEN CHAR_LENGTH(A.IDARTICULO) = 5 AND SUBSTRING(A.IDARTICULO FROM 1 FOR 1) = '2' THEN 'GAMA'
        END) AS SERVER,

        A.BARCODE,
        M.IDMOVIMIENTO,

        CAST(
            LPAD(COALESCE(S.COD_TIMBRADO, '0'), 3, '0') || '-' ||
            LPAD(COALESCE(M.PEXPEDICION, '0'), 3, '0') || '-' ||
            LPAD(COALESCE(M.NROMOVIMIENTO, '0'), 7, '0')
        AS VARCHAR(15)) AS NRO_FACTURA,

        EXTRACT(YEAR FROM M.FECHA) AS ANHO,

        TRIM(CASE EXTRACT(MONTH FROM M.FECHA)
            WHEN 1 THEN 'Enero' WHEN 2 THEN 'Febrero' WHEN 3 THEN 'Marzo'
            WHEN 4 THEN 'Abril' WHEN 5 THEN 'Mayo' WHEN 6 THEN 'Junio'
            WHEN 7 THEN 'Julio' WHEN 8 THEN 'Agosto' WHEN 9 THEN 'Septiembre'
            WHEN 10 THEN 'Octubre' WHEN 11 THEN 'Noviembre' WHEN 12 THEN 'Diciembre'
        END) AS MES,

        EXTRACT(MONTH FROM M.FECHA) AS NMES,
        EXTRACT(DAY FROM M.FECHA) AS DIA,

        TRIM(CASE EXTRACT(WEEKDAY FROM M.FECHA)
            WHEN 0 THEN 'Domingo' WHEN 1 THEN 'Lunes'
            WHEN 2 THEN 'Martes' WHEN 3 THEN 'Miércoles'
            WHEN 4 THEN 'Jueves' WHEN 5 THEN 'Viernes' WHEN 6 THEN 'Sábado'
        END) AS DIA_SEMANA,

        CAST(M.FECHA AS DATE) AS FECHA,

        LPAD(EXTRACT(HOUR FROM gc.apertura), 2, '0') || ':' ||
        LPAD(EXTRACT(MINUTE FROM gc.apertura), 2, '0') AS HORA,

        EXTRACT(HOUR FROM gc.apertura) AS HORA2,

        M.IDSUCURSAL,
        UPPER(TRIM(
            CASE
                WHEN M.IDPERSONA IN (1037107) THEN 'QSR'
                WHEN (M.IDTIPOMOVIMIENTO = 104 AND P.RUC IN ('80139112-1','80119519-5'))
                     OR (S.NOMBRE LIKE ('EVENTO%') AND P.RUC IN ('80139112-1','80119519-5'))
                     THEN 'CASA CENTRAL'
                WHEN S.NOMBRE IN ('CENTRO DE PRODUCCION','Planta de Produccion','PLANTA DE PRODUCCION') THEN 'ENEX'
                ELSE S.NOMBRE
            END)) AS SUCURSAL,

        DM.IDDEPOSITO,
        DP.DESCRIPCION AS DEPOSITO,

        M.IDORIGEN,
        gg_or.DESCRIPCION AS ORIGEN,

        M.IDPLANVENTA,
        GGM.NOMBRE AS PLANVENTA,

        M.IDPERSONA,
        P.RUC,
        P.DOCUMENTO AS DOCUMENTO_IDENTIDAD,
        P.PERSONA,

        A.IDFAMILIA,
        F.DESCRIPCION AS FAMILIA,

        A.IDLINEA,
        L.DESCRIPCION AS LINEA,

        DM.IDARTICULO,
        A.DESCRIPCION AS ARTICULO,

        A.IDMARCA,
        MC.DESCRIPCION AS MARCA,

        TRIM(CASE WHEN A.COMBO = 0 THEN 'FULL PRICE' ELSE 'PROMO' END) AS ETIQUETA_DE_PRECIO,

        SUM(DM.CANTIDAD) AS CANTIDAD,

        AVG(CASE WHEN DM.IMPUESTO <> 0 THEN (DM.PRECIO - DM.DESCUENTO) ELSE 0 END) AS GRAVADA,
        AVG(CASE WHEN DM.IMPUESTO = 0 THEN (DM.PRECIO - DM.DESCUENTO) ELSE 0 END) AS EXENTA,
        AVG(CASE WHEN DM.IMPUESTO <> 0 THEN (DM.PRECIO - DM.DESCUENTO) ELSE 0 END) * 0.1 AS IVA,

        AVG(DM.PRECIO_IVA) AS PRECIO_UNITARIO_SIN_DESCUENTO,

        DM.PORC_DESCUENTO,

        AVG(
            CASE WHEN DM.IMPUESTO <> 0
                THEN ROUND((DM.PRECIO_IVA - DM.PORC_DESCUENTO / 100 * DM.PRECIO_IVA), 0)
                ELSE DM.PRECIO_IVA
            END
        ) AS precio_unitario_con_descuento,

        SUM(CASE WHEN DM.IMPUESTO <> 0 THEN (DM.PRECIO - DM.DESCUENTO) ELSE 0 END * DM.CANTIDAD) AS TOTAL_GRAVADAS,
        SUM(CASE WHEN DM.IMPUESTO = 0 THEN (DM.PRECIO - DM.DESCUENTO) ELSE 0 END * DM.CANTIDAD) AS TOTAL_EXENTA,

        SUM((DM.PRECIO - DM.DESCUENTO) * DM.CANTIDAD) AS TOTAL_GRAVADAS_MAS_EXENTA,

        SUM(CASE WHEN DM.IMPUESTO <> 0 THEN (DM.PRECIO - DM.DESCUENTO) * 0.1 ELSE 0 END * DM.CANTIDAD) AS TOTAL_IVA,

        SUM(
            (CASE WHEN DM.IMPUESTO <> 0
                THEN ROUND((DM.PRECIO_IVA - DM.PORC_DESCUENTO /100 * DM.PRECIO_IVA),0)
                ELSE DM.PRECIO_IVA END
            ) * DM.CANTIDAD
        ) AS TOTAL_IMPORTE,

        /* FORMA DE PAGO INTEGRADA */
        REG.IDTIPOPAGO,
        TP.DESCRIPCION AS FORMA_PAGO,
        SUM(REG.MONTO) AS MONTO_FORMA_PAGO

    FROM
        MOVIMIENTOS M
        INNER JOIN DETALLEMOVIMIENTO DM ON M.IDMOVIMIENTO = DM.IDMOVIMIENTO
        INNER JOIN ARTICULO A ON A.IDARTICULO = DM.IDARTICULO
        INNER JOIN FAMILIAARTICULO F ON F.IDFAMILIA = A.IDFAMILIA
        INNER JOIN LINEA L ON L.IDLINEA = A.IDLINEA
        INNER JOIN MARCA MC ON MC.IDMARCA = A.IDMARCA
        INNER JOIN SUCURSAL S ON S.IDSUCURSAL = M.IDSUCURSAL
        INNER JOIN DEPOSITO DP ON DP.IDDEPOSITO = DM.IDDEPOSITO
        LEFT JOIN GG_ORIGEN gg_or ON gg_or.IDORIGEN = M.IDORIGEN
        INNER JOIN PERSONA P ON P.IDPERSONA = M.IDPERSONA
        LEFT JOIN GG_COMANDA gc ON gc.idmovimiento = M.IDMOVIMIENTO
        LEFT JOIN GG_MODULO GGM ON GGM.IDMODULO = GC.MODULO

        /* JOINS DE FORMA DE PAGO */
        LEFT JOIN DETALLERECIBO DR2 ON DR2.IDMOVIMIENTO = M.IDMOVIMIENTO
        LEFT JOIN RECIBOS RR ON RR.IDRECIBO = DR2.IDRECIBO
        LEFT JOIN REGISTRADORA REG ON REG.IDRECIBO = RR.IDRECIBO
        LEFT JOIN TIPOPAGO TP ON TP.IDTIPOPAGO = REG.IDTIPOPAGO

    WHERE
        M.ESTADO <> 'A'
        AND M.FECHA BETWEEN :desde AND :hasta
        AND M.IDTIPOMOVIMIENTO IN (30, 3, 62, 104, 61, 36, 37, 104)

    GROUP BY
        SERVER, A.BARCODE, M.IDMOVIMIENTO, NRO_FACTURA,
        M.FECHA, gc.apertura, M.IDSUCURSAL, SUCURSAL,
        DM.IDDEPOSITO, DP.DESCRIPCION, M.IDORIGEN, gg_or.DESCRIPCION,
        M.IDPLANVENTA, GGM.NOMBRE,
        M.IDPERSONA, P.RUC, P.DOCUMENTO, P.PERSONA,
        A.IDFAMILIA, F.DESCRIPCION,
        A.IDLINEA, L.DESCRIPCION,
        DM.IDARTICULO, A.DESCRIPCION,
        A.IDMARCA, MC.DESCRIPCION,
        A.COMBO, DM.PORC_DESCUENTO,

        /* GROUP BY de forma pago */
        REG.IDTIPOPAGO,
        TP.DESCRIPCION
)
